\documentclass[a4paper,12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[greek,english]{babel}
\usepackage{geometry}
\usepackage{enumitem}
\usepackage{alphabeta}
\usepackage{lmodern}
\usepackage{textcomp}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage[hidelinks]{hyperref}
\usepackage{tabularx}
\usepackage[dvipsnames]{xcolor}
\usepackage{listings}
\usepackage{graphicx}
\usepackage{float}
\usepackage{sudoku}
\graphicspath{{figures/}} % Path to images


%%% Font of characters %%
%\usepackage{fontspec}
%\setmainfont{cmun}[
%  Extension=.otf,
%  UprightFont=*rm,
%  ItalicFont=*ti,
%  BoldFont=*bx,
%  BoldItalicFont=*bi,
%]
%\setsansfont{cmun}[
%  Extension=.otf,
%  UprightFont=*ss,
%  ItalicFont=*si,
%  BoldFont=*sx,
%  BoldItalicFont=*so,
%]
%\setmonofont{cmun}[
%  Extension=.otf,
%  UprightFont=*btl,% light version
%  ItalicFont=*bto,%  light version
%  BoldFont=*tb,
%  BoldItalicFont=*tx,
%]

%\geometry{
%a4paper,
%width=170mm,
%top=25mm,
%bottom=25mm
%}

% \input{avrListing.tex}

% \lstdefinestyle{ListingSample}{
% 	basicstyle=\small\ttfamily,
% 	numbers=none,
% 	keywordstyle=\color{blue}\bfseries,
% 	morekeywords={begin,end,for,maxint,to,do},
% 	% pos=l,
% }

\setlength\parindent{0pt} % Removes all indentation from paragraphs

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}

%----------------------------------------------------------------------------------------
% DOCUMENT INFORMATION
%----------------------------------------------------------------------------------------

\begin{document}

\input{titlepage}

\newpage
\tableofcontents
\newpage

\section{Εισαγωγή}
Σκοπός του Project είναι η επίλυση ενός παιχνιδιού Sudoku (9x9 πλέγμα) χρησιμοποιώντας έναν μικροελεγκτή AVR. Η διεπαφή του μικροελεγκτή με τον εξωτερικό κόσμο υλοποιείται με χρήση της σειριακής θύρας RS232 και με τη χρήση του τερματικού προγραμμάτος putty.

\section{Τεχνολογία}
Για την υλοποίηση του project χρησιμοποιήθηκε η πλακέτα STK500 με τον μικροελεγκτή ATmega16L με συχνότητα ρολογιού 10MHz (εξωτερικός κρύσταλλος). Τα μοντέλα του μικροελεκτή και του κρυστάλλου τηρούν προδιαγραφές οι οποίες είναι κοινές για όλες τις ομάδες. Η συγγραφή του κώδικα πραγματοποιήθηκε στη γλώσσα C με τον avr-gcc compiler (έκδοση 5.4.0). Για το κατέβασμα του κώδικα στη πλακέτα STK500 χρησιμοποιήθηκε η πλατφόρμα Microchip Studio με τη χρήση του προγραμματιστή avrdude. Για την επικοινωνία της πλακέτα με τον εξωτερικό κόσμο χρησιμοποιήθηκε ένα καλώδιο USB σε Serial RS232 (βύσμα DB9).


\section{Περιγραφή της υλοποίησης}
Το πρότζεκτ αποτελείται απο 4 μέρη τα οποία είναι η διεπαφή της σειριακής θύρας, η επεξεργασία των εντολών, ο αλγόριθμος επίλυσης του Sudoku και η οθόνη, η οποία εμφανίζει τη πρόοδο επίλυσης του Sudoku. 

\subsection{Σειριακή Θύρα RS232}
Η επικοινωνία του μικροελεγκτή με το χρήστη επιτυγχάνεται μέσω της σειριακής θύρας ορίζοντας τις παραμέτρους της έτσι ώστε να τηρούν τις προδιαγραφές:\\
\begin{itemize}
	\item BAUD rate 9600 bps
	\item 8 data bits
	\item No parity
	\item 1 stop bit
\end{itemize}

Για το σετάρισμα του BAUD rate στην τιμή 9600 φορρτώθηκε στον 16-bit καταχωρητή UBRR η τιμή $F\_CPU/16/USART\_BAUDRATE - 1  = 10 * 10^6 / 16 / 9600 - 1 = 64.10$, το οποίο απλοποιείται στο 64 (ο UBRR δέχεται ακέραιες τιμές).

Στη συνέχεια, ενεργοποιείται η λήψη και η μετάδοση δεδομένων μέσω των flags RXEN και TXEN του UCSRB. Τα interrupt flags τόσο της λήψης όσο και της μετάδοσης, ενεργοποιούνται προκειμένου ο μικροελεγκτής να λαμβάνει και να μεταδίδει δεδομένα με χρήση interrupts αντί για polling. Το τελευταίο δεν προτιμήθηκε λόγω χαμηλότερης απόδοσης.

Τέλος, για την ρύθμιση 8 data bits, αρχικά ενεργοποιείται ο UCSRC (ίδιος με τον UBRRH) με το URSEL bit και τίθενται τα UCSZ0 και UCSZ1 στην τιμή 1. Για τη ρύθμιση του parity και του stop bit, δεν απαιτείται κάποια ενέργεια καθώς είναι αυτόματα ρυθμισένα στην επιθυμητή τιμή (0).


% \lstinputlisting[label=code:initUART, language=C, firstline=251, lastline=265, tabsize=2, caption=Κώδικας αρχικοποίησης UART]{main.c}

\subsection{Επεξεργασία των εντολών}
Οι εντολές που υποστηρίζει το ενσωματώμενο σύστημα παρατίθενται στο Table~\ref{table:commands}. Οι εντολές εκτελούνται στο main loop όταν καλείται η συνάρτηση process(). Σε αυτή αρχικά διαβάζεται ο receive buffer και αποκωδικοποείται μία νέα εντολή, εφόσον υπάρχει. Στη συνέχεια εκτελείται η αντίστοιχη ενέργεια και μεταδίδεται η απάντηση από τον AVR χρησιμοποιώντας τη συνάρτηση transmit() η οποία περιοδικά εξετάζει εάν υπάρχει νέος χαρακτήρας προς μετάδοση και αν υπάρχει τον στέλνει στο PC.


\begin{table}[h!]
\centering
\begin{tabular}[c]{| p{0.3\textwidth} | p{0.3\textwidth} | p{0.3\textwidth} |}
\hline
\textbf{Εντολή από PC ή AVR} & \textbf{Ενέργεια εντολής} & \textbf{Απάντηση προς PC ή AVR} \\
\hline
"\textbf{AT}\textbackslash r\textbackslash n" (Από PC) & Έναρξη επικοινωνίας με τον AVR & "\textbf{OK}\textbackslash r\textbackslash n" (Προς AVR)\\
\hline
"\textbf{C}\textbackslash r\textbackslash n" (Από PC) & Καθαρισμός πίνακα και οθόνης  & "\textbf{OK}\textbackslash r\textbackslash n" (Προς AVR)\\
\hline
"\textbf{N}XYVAL\textbackslash r\textbackslash n" (Από PC) &  Τιμή κελιού (VAL) sudoku[Χ][Υ], Χ,Υ $\in$ [1,9] & "\textbf{OK}\textbackslash r\textbackslash n" (Προς AVR)\\
\hline
"\textbf{P}\textbackslash r\textbackslash n" (Από PC) & Ξεκινάει να παίζει-λύνει το παιχνίδι & "\textbf{OK}\textbackslash r\textbackslash n" (Προς AVR)\\
\hline
"\textbf{S}\textbackslash r\textbackslash n" (Από PC) & Ρωτάει τον AVR αν τέλειωσε η λύση του Sudoku  & "\textbf{D}\textbackslash r\textbackslash n" αν έχει τελειώσει (Προς AVR)\\
\hline
"\textbf{T}\textbackslash r\textbackslash n" (Από PC) & Στέλνει τμές κελιών στο PC, μία τιμή κάθε φορά που λαμβάνει αυτή την εντολή & "\textbf{N}XYVAL\textbackslash r\textbackslash n" (Προς AVR)\\
\hline
"\textbf{D}\textbackslash r\textbackslash n" (Από AVR) & Ρωτάει τον AVR αν του έστειλε όλα τα δεδομένα & "\textbf{OK}\textbackslash r\textbackslash n" (Προς PC)\\
\hline
"\textbf{B}\textbackslash r\textbackslash n" (Από PC) & Σταμάτησε τους υπολογισμούς ή τη μετάδοση αποτελεσμάτων (warm start) & "\textbf{OK}\textbackslash r\textbackslash n" (Προς AVR)\\
\hline
"\textbf{D}XYVAL\textbackslash r\textbackslash n" (Από PC) & Στέλνει τα περιεχόμενα του κελιού sudoku[X][Y] & "\textbf{N}XYVAL\textbackslash r\textbackslash n" (Προς AVR)\\
\hline
\end{tabular}
\renewcommand{\arraystretch}{1.2}
\caption{Σετ εντολών}
\label{table:commands}
\end{table}


\subsection{Αλγόριθμός επίλυσης Sudoku}
Για την επίλυση του Sudoku χρησιμοποιήθηκε ένας απλός αναδρομικός backtrack αλγόριθμος. Ο αλγόριθμος αρχικά βρίσκει ένα άδειο κελί και αποθηκεύει την 1η έγκυρη εικασία, ξεκινώντας από το 1 με μέγιστο τιμή το 9. Για να είναι έγκυρη μία εικασία, θα πρέπει ο συγκεκιρμένος αριθμός να μην βρίσκεται ήδη στην ίδια γραμμή, στήλη και 3x3 τετράγωνο. Εφόσον το Sudoku περιέχει πλέον ένα παραπάνω συμπληρωμενο κελί, γίνεται η αναδρομική κλήση. Εάν, η συνάρτηση επίλυσης (solve) επιστρέψει 0, τότε γίνεται backtrack μηδενίζοντας το συγκεκριμένο κελί. Η solve θα επιστρέψει 0, μόνο όταν κάποιο άδειο κελί δεν μπορεί να πάρει καμία τιμή μεταξύ 1 και 9.\\
Λόγω του διαγωνισμού, στον οποίο θα πάρει μέρος κάθε ομάδα υλοποιήθηκε και ένας βελτιστοποιημένος αλγόριθμος επίλυσης, ωστόσο ήταν ανάγκαια η χρήση δυναμικά κατανεμημένης μνήμης και το αποτυπώμα της μνήμης ήταν μεγάλο. Τα δύο παραπάνω παρατηρήθηκαν αφού πρώτα έγινε η υλοποίηση του βελτιστοποιημένου αλγορίθμου σε απλή C και εκτελώντας τον σε επεξεργαστή γενικού σκοπού. Τέλος, κατεβάζοντας τον βελτιστοποιημένο αλγόριθμο στον ATmega16L, το αποτέλεσμα ήταν να μη λύνονται αρκετά Sudoku λόγω αδυναμίας παραχώρησης παραπάνω μνήμης. Η ανάλυση του βελτιστοποιημένου κώδικα και η σύγκρισή του (σε επεξεργαστή γενικού σκοπού, όχι σε AVR) με τον απλό αλγόριθμο βρίσκεται στο Παράρτημα Β.\\


\subsubsection{Απόδοση αλγορίθμων επίλυσης Sudoku}
Στον Πίνακα~\ref{table:solv_perf_avr} αποτυπώνεται ο χρόνος επίλυσης διαφορετικών βαθμών δυσκολίας Sudoku.


\subsection{Οθόνη - Progress Bar}
Για την απεικόνιση της προόδου επίλυσης του Sudoku χρησιμοποιήθηκαν τα LEDs κοινής ανόδου (CA) της πλακέτας. Συγκεκριμένα κατά τη διάρκεια επίλυσης του Sudoku πραγματοποιείται περιοδικά έλεγχος σχετικά με το πόσα κελιά του πίνακα είναι συμπληρωμένα, με βάση αυτόν τον αριθμό ανάβει ο ανάλογος αριθμός LEDs (Table~\ref{table:progress_bar}).
Για την υλοποίηση της περιοδικής ανανέωσης των LEDs χρησιμοποιήθηκε ο Timer 0 σε λειτουργία compare θέτωντας το καταχωρητή OCR0 στη τιμή 125 κατά την αρχικοποίηση του Timer 0. Ο prescaler τέθηκε στην τιμή 256 θέτωντας στο καταχωρητή TCCR0 το bit CS02 ίσο με 1.Με βάση τις παρaπάνω τιμές αρχικοποιήσης του Timer 0 και τον παρακάτω τύπο υπολογίστηκε ότι η οθόνη έχει ρυθμό ανανεώσης 38 Hz.\\
$f_{OC0} = \frac{f_{CLK}}{2*N*(1+OCR0)} = \frac{10 MHz}{2*1024*126)} = 38.44 Hz$ \\


\begin{table}[h!]
\centering
\begin{tabular}[c]{| c | c |}
\hline
LEDs & Clues found \\
\hline
LEDs off & $< 10$ \\
\hline
LED00 &  $\geq 10$ \\
\hline
LED00-01 & $\geq 20$ \\
\hline
LED00-02 & $\geq 30$ \\
\hline
LED00-03 & $\geq 40$ \\
\hline
LED00-04 & $\geq 50$ \\
\hline
LED00-05 & $\geq 60$ \\
\hline
LED00-06 & $\geq 70$ \\
\hline
LED00-07 & $\geq 80$ \\
\hline
\end{tabular}
% \renewcommand{\arraystretch}{1.2}
\caption{Progress Bar}
\label{table:progress_bar}
\end{table}




% \begin{figure}[h!]
% \centering
% \includegraphics[scale=0.75]{lab5_flo.png}
% \caption{Ροοδιάγραμμα του προγράμματος.}
% \end{figure}


\section{Έλεγχος σωστής λειτουργίας}

% Η σωστή λειτουργία του συστήματος ελέγθηκε για κάθε υποσύστημα ξεχωριστά. 

% Η επιβεβαίωση της ορθής λειτουργίας τόσο της σειριακής θύρας όσο και της εκτέλεσης των εντολών ΔΕΝ κατέστη δυνατή. Αυτό συνέβη καθώς η αναπτυξιακή πλακέτα STK500 η οποία μας δόθηκε είχε πρόβλημα στη μετάδοση δεδομένων πίσω στο PC.

% Η διαπίστωση του προβλήμστος της πλάκετας έγινε δυνατή με τη χρήση πλάκετας άλλης ομάδας. Συγκεκριμένα ανατπύχθηκε ένα απλό πρόγραμμα το οποίο επιτρέφει στον αποστολέα τους χαρατκήρες που του έστειλε. Στη δική μας πλακέτα αυτό που επέστρεφε το πρόγραμμα ήταν σκουπίδια ενώ στη πλακέτα της άλλης όμάδας επιστρέφονταν οι χαρασκτήρες που είχαν μεταδοθεί. Επίσης διαπιστώθηκε ότι το καλώδιο δεν ήταν αυτός ή αιτία του προβλήματος χρησιμοποιώντας το καλώδιο της άλλης ομάδας. 

% Η απεικόνιση της προόδου λειτούργησε κατόπιν πολλαπλών ελέγχων πάνω στη πλακέτα κάθως τόσο τα LEDs όσο και το PORT A λειουργούσαν ορθά.  

% \section{Συμπεράσματα}

\section{Παράρτημα A - Τα Sudoku παζλ που χρησιμοποιήθηκαν}

\subsection{easy puzzle}

\setlength\sudokusize{7cm}

\begin{sudoku}
|1|7|4| |9| |6| | |.
| | | | |3|8|1|5|7|.
|5|3| |7| |1| | |4|.
| | |7|3|4|9|8| | |.
|8|4| |5| | |3|6| |.
|3| |5| | |6|4|7| |.
|2|8|6|9| | | | |1|.
| | | |6|2|7| |3|8|.
| |5|3| |8| | |9|6|.
\end{sudoku}


\subsection{easy2 puzzle}

\begin{sudoku}
|1| |5|7| |2|6|3|8|.
|2| | | | |6| | |5|.
| |6|3|8|4| |2|1| |.
| |5|9|2| |1|3|8| |.
| | |2| |5|8| | |9|.
|7|1| | |3| |5| |2|.
| | |4|5|6| |7|2| |.
|5| | | | |4| |6|3|.
|3|2|6|1| |7| | |4|.
\end{sudoku}


\subsection{inter puzzle}

\begin{sudoku}
|5|1|7|6| | | |3|4|.
|2|8|9| | |4| | | |.
|3|4|6|2| |5| |9| |.
|6| |2| | | | |1| |.
| |3|8| | |6| |4|7|.
| | | | | | | | | |.
| |9| | | | | |7|8|.
|7| |3|4| | |5|6| |.
| | | | | | | | | |.
\end{sudoku}


\subsection{inter2 puzzle}

\begin{sudoku}
|5|1|7|6| | | |3|4|.
| |8|9| | |4| | | |.
|3| |6|2| |5| |9| |.
|6| | | | | | |1| |.
| |3| | | |6| |4|7|.
| | | | | | | | | |.
| |9| | | | | |7|8|.
|7| |3|4| | |5|6| |.
| | | | | | | | | |.
\end{sudoku}


\subsection{diff puzzle}

\begin{sudoku}
| | |5|3| | | | | |.
|8| | | | | | |2| |.
| |7| | |1| |5| | |.
|4| | | | |5|3| | |.
| |1| | |7| | | |6|.
| | |3|2| | | |8| |.
| |6| |5| | | | |9|.
| | |4| | | | |3| |.
| | | | | |9|7| | |.
\end{sudoku}


\subsection{hard puzzle}

\begin{sudoku}
|8|5| | | |2|4| | |.
|7|2| | | | | | |9|.
| | |4| | | | | | |.
| | | |1| |7| | |2|.
|3| |5| | | |9| | |.
| |4| | | | | | | |.
| | | | |8| | |7| |.
| |1|7| | | | | | |.
| | | | |3|6| |4| |.
\end{sudoku}


\section{Παράρτημα B - Ανάλυση και απόδοση βελτιστοποιημένου αλγορίθμου}
Ο βελτιστοποιημένος αλγόριθμος αρχικά


Παρακάτω παρτίθενται τα αποτελέσματα από τη σύγκριση του απλού και του βελτιστοποιημένου αλγορίθμου επίλυσης


\begin{table}[h!]
\centering
\begin{tabular}[c]{| c | c | c | c |}
\hline
Sudoku & Επιλύθηκε & Χρόνος & Αριθμός backtracks \\
\hline
easy                      & Ναι & 0.068133 ms & 21 \\
\hline
easy\textunderscore opt   & Ναι & 0.122267 ms & 0 \\
\hline
easy2                     & Ναι & 0.086267 ms & 34 \\
\hline
easy2\textunderscore opt  & Ναι & 0.0958 ms & 1 \\
\hline
inter                     & Ναι & 0.853 ms & 579 \\
\hline
inter\textunderscore opt  & Όχι & 0.186467 ms & 6 \\
\hline
inter2                    & Ναι & 7.866733 ms & 6363 \\
\hline
inter2\textunderscore opt & Όχι & 0.004379 ms & 7 \\
\hline
diff                      & Ναι & 5.6304 ms & 9949 \\
\hline
diff\textunderscore opt   & Όχι & 0.555 ms & 9 \\
\hline
hard                      & Ναι & 161.5358 ms & 335578 \\
\hline
hard\textunderscore opt   & Όχι & 0.637267 ms & 11 \\
\hline
\end{tabular}
% \renewcommand{\arraystretch}{1.2}
\caption{Μέσος χρόνος επίλυσης των παζλ του Παραρτήματος Α με χρήση του απλού και του βελτιστοποιημένου αλγορίθμου σε επεξεργαστή γενικού σκοπού.}
\label{table:bench_simple_opt}
\end{table}

\end{document}